---
layout: post
title: "Como organizar projetos de Terraform [Azure]"
author: asilva
date: 2023-03-03 09:20 -0300
categories: [DevOps, Terraform]
tags: [devops, terraform, hashicorp, automacao, iac, cicd, azure]
---

Fala galera! Seis t√£o baum?

Hoje vamos falar de **Terraform**!

Primeiramente, vamos fazer uma breve abordagem do que √© o **Terraform**.

O **Terraform** √© uma ferramenta de **infraestrutura como c√≥digo (IaC)** que permite definir, criar e gerenciar infraestruturas de forma automatizada e program√°tica. Com o Terraform, √© poss√≠vel descrever a infraestrutura em um arquivo de configura√ß√£o declarativo e, em seguida, usar esse arquivo para provisionar e gerenciar os recursos necess√°rios em nuvens p√∫blicas, privadas ou em ambientes locais. O Terraform √© capaz de gerenciar recursos de diferentes provedores de nuvem, permitindo que equipes de desenvolvimento e opera√ß√µes trabalhem juntas para criar e gerenciar infraestruturas de forma mais eficiente e escal√°vel. Al√©m disso, o Terraform oferece recursos para versionamento, controle de acesso, valida√ß√£o e visualiza√ß√£o de altera√ß√µes, tornando mais f√°cil a colabora√ß√£o e a manuten√ß√£o de infraestruturas complexas.

Um dos aspectos mais importantes da utiliza√ß√£o do Terraform √© a organiza√ß√£o do c√≥digo.

Organizar projetos em Terraform √© uma pr√°tica crucial para garantir que sua infraestrutura esteja bem gerenciada, escal√°vel e segura. Uma boa organiza√ß√£o permitir√° que voc√™ mantenha facilmente seu c√≥digo e fa√ßa altera√ß√µes rapidamente, sem comprometer a integridade de sua infraestrutura.

Existem diferentes maneiras de estruturar sua configura√ß√£o de Terraform, e a escolha depende das necessidades e complexidade do seu projeto. Neste artigo, exploraremos algumas abordagens comuns de organiza√ß√£o de projetos Terraform no Microsoft Azure.

### **1. Monol√≠tica**

Esta √© a forma mais simples e b√°sica de organizar um projeto Terraform. Todos os recursos s√£o declarados em um √∫nico arquivo main.tf. Embora seja f√°cil de criar e entender, esse m√©todo pode se tornar complicado √† medida que o projeto cresce e se torna mais complexo. Al√©m disso, se houver uma mudan√ßa em um recurso espec√≠fico, todo o arquivo principal ter√° que ser atualizado.

**Exemplo de estrutura de c√≥digo:**

```
üì¶01_terraform_monolithic
 ‚î£ üìú.gitignore
 ‚î£ üìúREADME.md
 ‚îó üìúmain.tf
```

**Exemplo de recurso:**

```bash
# Azure Provider source and version being used
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=2.83.0"
    }
  }
}

# Configure the Microsoft Azure Provider and identity
provider "azurerm" {
  features {}
}

# Configure Resources

# Virtual Machine
variable "prefix" {
  default = "unicastcloud"
}

resource "azurerm_resource_group" "rg" {
  name     = "${var.prefix}-resources"
  location = "eastus"
}

resource "azurerm_virtual_network" "main" {
  name                = "${var.prefix}-network"
  address_space       = ["10.0.0.0/16"]
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}

resource "azurerm_subnet" "internal" {
  name                 = "internal"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.main.name
  address_prefixes     = ["10.0.2.0/24"]
}

resource "azurerm_network_interface" "main" {
  name                = "${var.prefix}-nic"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  ip_configuration {
    name                          = "testconfiguration1"
    subnet_id                     = azurerm_subnet.internal.id
    private_ip_address_allocation = "Dynamic"
  }
}

resource "azurerm_virtual_machine" "main" {
  name                  = "${var.prefix}-vm"
  location              = azurerm_resource_group.rg.location
  resource_group_name   = azurerm_resource_group.rg.name
  network_interface_ids = [azurerm_network_interface.main.id]
  vm_size               = "Standard_DS1_v2"

  storage_image_reference {
    publisher = "Canonical"
    offer     = "UbuntuServer"
    sku       = "16.04-LTS"
    version   = "latest"
  }
  storage_os_disk {
    name              = "myosdisk1"
    caching           = "ReadWrite"
    create_option     = "FromImage"
    managed_disk_type = "Standard_LRS"
  }
  os_profile {
    computer_name  = "hostname"
    admin_username = "testadmin"
    admin_password = "Password1234!"
  }
  os_profile_linux_config {
    disable_password_authentication = false
  }
  tags = {
    ProjectName  = "demo-unicast"
    Env          = "Azure"
    Owner        = "Unicast Cloud"
    BusinessUnit = "Unicast Cloud"
    ServiceClass = "Gold"
  }
}
```

Mais detalhes no reposit√≥rio: <a href="https://github.com/asilvajunior/devops-case-studies/tree/main/01_terraform_monolithic" target="_blank">Terraform on Azure Reference Monolithic Sample</a> 

### **2. Multi Monol√≠tica:**

Nesta abordagem, cada ambiente √© separado em um diret√≥rio diferente, cada um com seu pr√≥prio arquivo main.tf. Isso torna mais f√°cil gerenciar recursos espec√≠ficos do ambiente, pois h√° um arquivo separado para cada ambiente. No entanto, isso pode levar a uma duplica√ß√£o desnecess√°ria de c√≥digo, pois recursos comuns s√£o duplicados em cada arquivo.

**Exemplo de estrutura de c√≥digo:**

```
üì¶02_terraform_multi_monolithic
 ‚î£ üìÇdev
 ‚îÉ ‚îó üìúmain.tf
 ‚î£ üìÇprod
 ‚îÉ ‚îó üìúmain.tf
 ‚î£ üìú.gitignore
 ‚îó üìúREADME.md
```

**Exemplo de recurso:**

**DEV**

```bash
# Azure Provider source and version being used
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=2.83.0"
    }
  }
}

# Configure the Microsoft Azure Provider and identity
provider "azurerm" {
  features {}
}

# Configure Resources

# Virtual Machine
variable "prefix" {
  default = "unicastcloud"
}

resource "azurerm_resource_group" "rg" {
  name     = "${var.prefix}-resources-dev"
  location = "eastus"
}

resource "azurerm_virtual_network" "main" {
  name                = "${var.prefix}-network-dev"
  address_space       = ["10.0.0.0/16"]
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}

resource "azurerm_subnet" "internal" {
  name                 = "internal-dev"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.main.name
  address_prefixes     = ["10.0.2.0/24"]
}

resource "azurerm_network_interface" "main" {
  name                = "${var.prefix}-nic-dev"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  ip_configuration {
    name                          = "testconfiguration1"
    subnet_id                     = azurerm_subnet.internal.id
    private_ip_address_allocation = "Dynamic"
  }
}

resource "azurerm_virtual_machine" "main" {
  name                  = "${var.prefix}-vm-dev"
  location              = azurerm_resource_group.rg.location
  resource_group_name   = azurerm_resource_group.rg.name
  network_interface_ids = [azurerm_network_interface.main.id]
  vm_size               = "Standard_DS1_v2"

  storage_image_reference {
    publisher = "Canonical"
    offer     = "UbuntuServer"
    sku       = "16.04-LTS"
    version   = "latest"
  }
  storage_os_disk {
    name              = "myosdisk1"
    caching           = "ReadWrite"
    create_option     = "FromImage"
    managed_disk_type = "Standard_LRS"
  }
  os_profile {
    computer_name  = "hostname"
    admin_username = "testadmin"
    admin_password = "Password1234!"
  }
  os_profile_linux_config {
    disable_password_authentication = false
  }
  tags = {
    ProjectName  = "demo-unicast"
    Env          = "Azure"
    Owner        = "Unicast Cloud"
    BusinessUnit = "Unicast Cloud"
    ServiceClass = "Gold"
    Env          = "dev"
  }
}
```

**PROD**

```bash
# Azure Provider source and version being used
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=2.83.0"
    }
  }
}

# Configure the Microsoft Azure Provider and identity
provider "azurerm" {
  features {}
}

# Configure Resources

# Virtual Machine
variable "prefix" {
  default = "unicastcloud"
}

resource "azurerm_resource_group" "rg" {
  name     = "${var.prefix}-resources-prod"
  location = "eastus"
}

resource "azurerm_virtual_network" "main" {
  name                = "${var.prefix}-network-prod"
  address_space       = ["10.0.0.0/16"]
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}

resource "azurerm_subnet" "internal" {
  name                 = "internal-prod"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.main.name
  address_prefixes     = ["10.0.2.0/24"]
}

resource "azurerm_network_interface" "main" {
  name                = "${var.prefix}-nic-prod"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  ip_configuration {
    name                          = "testconfiguration1"
    subnet_id                     = azurerm_subnet.internal.id
    private_ip_address_allocation = "Dynamic"
  }
}

resource "azurerm_virtual_machine" "main" {
  name                  = "${var.prefix}-vm-prod"
  location              = azurerm_resource_group.rg.location
  resource_group_name   = azurerm_resource_group.rg.name
  network_interface_ids = [azurerm_network_interface.main.id]
  vm_size               = "Standard_DS1_v2"

  storage_image_reference {
    publisher = "Canonical"
    offer     = "UbuntuServer"
    sku       = "16.04-LTS"
    version   = "latest"
  }
  storage_os_disk {
    name              = "myosdisk1"
    caching           = "ReadWrite"
    create_option     = "FromImage"
    managed_disk_type = "Standard_LRS"
  }
  os_profile {
    computer_name  = "hostname"
    admin_username = "testadmin"
    admin_password = "Password1234!"
  }
  os_profile_linux_config {
    disable_password_authentication = false
  }
  tags = {
    ProjectName  = "demo-unicast"
    Env          = "Azure"
    Owner        = "Unicast Cloud"
    BusinessUnit = "Unicast Cloud"
    ServiceClass = "Gold"
    Env          = "prod"
  }
}
```

Mais detalhes no reposit√≥rio: <a href="https://github.com/asilvajunior/devops-case-studies/tree/main/02_terraform_multi_monolithic" target="_blank">Terraform on Azure Reference Multi Monolithic</a> 

### **3. Modular:**

O uso de m√≥dulos permite a reutiliza√ß√£o de c√≥digo em v√°rios projetos Terraform. Em vez de definir todos os recursos em um √∫nico arquivo, cada recurso √© colocado em seu pr√≥prio m√≥dulo, com um arquivo separado para cada recurso. Isso torna mais f√°cil gerenciar e reutilizar o c√≥digo, pois os m√≥dulos podem ser facilmente importados em outros projetos.

**Exemplo de estrutura de c√≥digo:**

```
üì¶03_terraform_modular
 ‚î£ üìÇmodules
 ‚îÉ ‚î£ üìÇdns
 ‚îÉ ‚îÉ ‚îó üìúmain.tf
 ‚îÉ ‚îó üìÇvm
 ‚îÉ ‚îÉ ‚îó üìúmain.tf
 ‚î£ üìú.DS_Store
 ‚î£ üìú.gitignore
 ‚î£ üìú.terraform-docs.yml
 ‚î£ üìúMakefile
 ‚î£ üìúREADME.md
 ‚îó üìúmain.tf
```

**Exemplo de recurso:**

```bash
# Azure Provider source and version being used
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=2.83.0"
    }
  }
}

# Configure the Microsoft Azure Provider and identity
provider "azurerm" {
  features {}
}

# Modules

# Virtual Machine
module "vm" {
  source = "./modules/vm"
}

module "dns" {
  source = "./modules/dns"
}
```

Mais detalhes no reposit√≥rio: <a href="https://github.com/asilvajunior/devops-case-studies/tree/main/03_terraform_modular" target="_blank">Terraform on Azure Reference Modular</a> 

### **4. Multi Ambiente:**

Esta abordagem envolve o uso de workspaces e arquivos tfvars separados para cada ambiente. Os workspaces permitem que voc√™ execute o mesmo c√≥digo em v√°rios ambientes, enquanto os arquivos tfvars permitem que voc√™ configure as vari√°veis espec√≠ficas de cada ambiente. Isso torna mais f√°cil gerenciar recursos para diferentes ambientes e permite que voc√™ execute o mesmo c√≥digo em diferentes ambientes.

**Exemplo de estrutura de c√≥digo:**

```
üì¶04_terraform_modular_multi_env
 ‚î£ üìÇ.terraform
 ‚îÉ ‚îó üìÇmodules
 ‚îÉ ‚îÉ ‚îó üìúmodules.json
 ‚î£ üìÇenv
 ‚îÉ ‚î£ üìÇdev
 ‚îÉ ‚îÉ ‚îó üìúdev.tfvars
 ‚îÉ ‚î£ üìÇprd
 ‚îÉ ‚îÉ ‚îó üìúprod.tfvars
 ‚îÉ ‚îó üìÇqa
 ‚îÉ ‚îÉ ‚îó üìúqa.tfvars
 ‚î£ üìÇmodules
 ‚îÉ ‚î£ üìÇdns
 ‚îÉ ‚îÉ ‚î£ üìúREADME.md
 ‚îÉ ‚îÉ ‚î£ üìúmain.tf
 ‚îÉ ‚îÉ ‚î£ üìúoutputs.tf
 ‚îÉ ‚îÉ ‚îó üìúvariables.tf
 ‚îÉ ‚îó üìÇvm
 ‚îÉ ‚îÉ ‚î£ üìúREADME.md
 ‚îÉ ‚îÉ ‚î£ üìúmain.tf
 ‚îÉ ‚îÉ ‚î£ üìúoutputs.tf
 ‚îÉ ‚îÉ ‚îó üìúvariables.tf
 ‚î£ üìú.DS_Store
 ‚î£ üìú.gitignore
 ‚î£ üìúREADME.md
 ‚î£ üìúmain.tf
 ‚î£ üìúproviders.tf
 ‚î£ üìúvariables.tf
 ‚îó üìúversions.tf
```

**Exemplo de recurso:**

**MAIN.TF**

```bash
# Virtual Machine
module "vm" {
  source = "./modules/vm"

  prefix = var.prefix
  location = var.location
  tags = var.tags
  subnet_name = var.subnet_name
  address_space = var.address_space
  address_prefixes = var.address_prefixes
  ip_conf_name = var.ip_conf_name
  private_ip_address_allocation  = var.private_ip_address_allocation
  vm_size = var.vm_size
  publisher = var.publisher
  offer = var.offer
  sku = var.sku
  os_disk_name = var.os_disk_name
  caching = var.os_caching
  os_create_option = var.os_create_option
  managed_disk_type = var.managed_disk_type
  computer_name = var.computer_name
  admin_username = var.admin_username
  admin_password = var.admin_password
  disable_password_authentication = var.disable_password_authentication
}

module "dns" {
  source = "./modules/dns"

  prefix = var.prefix
  location = var.location
  dns_name = dns_name
}
```

**DEV.TFVARS**

```bash
# Global variables
location  = "eastus"
prefix = "unicastcloud-dev"
tags = {
    ProjectName  = "demo-unicast-dev"
    Env          = "Azure"
    Owner        = "Unicast Cloud"
    BusinessUnit = "Unicast Cloud"
    ServiceClass = "Gold"
    Env          = "dev"
}

# DNS variables
dns_name = unciastcloud.io

# Virtual Machine variables
subnet_name = "internal"
address_space = "10.0.2.0/24"
address_prefixes = "10.0.0.0/16"
ip_conf_name = "testconfiguration1"
private_ip_address_allocation  = "Dynamic"
vm_size = "Standard_DS1_v2"
publisher = "Canonical"
offer = "UbuntuServer"
sku = "16.04-LTS"
os_disk_name = "myosdisk1"
os_caching = "ReadWrite"
os_create_option = "FromImage"
managed_disk_type = "Standard_LRS"
computer_name = "hostname"
admin_username = "testadmin"
admin_password = "Password1234!"
disable_password_authentication = false
```

Mais detalhes no reposit√≥rio: <a href="https://github.com/asilvajunior/devops-case-studies/tree/main/04_terraform_modular_multi_env" target="_blank">Terraform on Azure Reference Modular Multi Environment Sample</a> 

Organizar seus projetos em Terraform pode parecer uma tarefa pequena, mas √© uma parte importante do processo de desenvolvimento. 

Em resumo, a organiza√ß√£o adequada do seu projeto Terraform √© fundamental para garantir que sua infraestrutura seja gerenciada corretamente. A escolha da estrutura depende das necessidades do seu projeto, e as abordagens apresentadas aqui podem ser adaptadas para atender √†s suas necessidades espec√≠ficas. Se voc√™ est√° come√ßando um novo projeto, √© recomend√°vel optar por uma abordagem modular e multi ambiente, que permitir√° uma escalabilidade f√°cil e uma gest√£o mais eficiente dos seus recursos.

Independentemente da abordagem escolhida, √© importante manter a consist√™ncia na organiza√ß√£o do seu c√≥digo Terraform e seguir as melhores pr√°ticas para evitar conflitos e erros. Al√©m disso, √© fundamental documentar sua estrutura e criar um processo de revis√£o de c√≥digo para garantir que as mudan√ßas em sua infraestrutura sejam devidamente validadas antes de serem implementadas.

Com uma organiza√ß√£o adequada, o Terraform pode ser uma ferramenta poderosa para gerenciar a infraestrutura do seu projeto no Microsoft Azure e garantir um ambiente seguro, escal√°vel e confi√°vel.

√â isso galera, espero que gostem!

Forte Abra√ßo!
